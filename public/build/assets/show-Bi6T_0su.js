const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/echo-CLQcSlIV.js","assets/app-zh9bNfQA.js","assets/app-BttOwSmz.css"])))=>i.map(i=>d[i]);
import{r as a,_ as ee,j as e,H as te,L as se,a as M}from"./app-zh9bNfQA.js";import{I as re}from"./input-error-2-LekhPz.js";import{B as O}from"./createLucideIcon-BZjvJ1Zn.js";import{B as _}from"./badge-VllgXE3C.js";import{T as ae}from"./textarea-vl710I3f.js";import{S as B,a as F,b as V,c as U,d as x}from"./select-Bf_U1fyU.js";import{f as ne}from"./format-relative-time-CysDwhSm.js";import{A as de}from"./admin-layout-BWrldFRv.js";import{A as ie}from"./arrow-left-ClfvWti0.js";import{C as oe}from"./chevron-up-DTZu2ggr.js";import{C as le}from"./chevron-down-C7_CWyHS.js";/* empty css            */import"./index-Bvd5418W.js";import"./x-BIBjS2Dr.js";import"./index-CvHCqEC4.js";import"./chevron-right-O9ILxyvV.js";import"./check-BlMOmQr2.js";import"./app-sidebar-header-CRr_1DPO.js";import"./index-NEtNT4ix.js";import"./appearance-dropdown-Bb28oTQN.js";import"./index-BH508O9j.js";import"./index-BJwOBxES.js";import"./index-CcLcdVZM.js";import"./log-out-D2fYovF8.js";import"./shield-DgxHpXTb.js";import"./users-DRMz8fhj.js";import"./message-square-CrR61UD7.js";import"./file-text-DIkPgk9X.js";import"./lock-BsRQ3mjQ.js";import"./credit-card-DZtV9Y3R.js";import"./chart-column-S0VcatN5.js";import"./index-CaEI0-fE.js";const ce=[".ticket.updated",".ticket.message.created"];function me(i){i&&typeof i.stopListening=="function"&&ce.forEach(o=>i.stopListening(o))}const ue=[{title:"Admin",href:"/admin"},{title:"Tickets",href:"/admin/tickets"},{title:"Ticket Details",href:"#"}],pe={open:"bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300",in_progress:"bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-300",closed:"bg-gray-100 text-gray-800 dark:bg-gray-900 dark:text-gray-300"},xe={low:"bg-gray-100 text-gray-800 dark:bg-gray-900 dark:text-gray-300",medium:"bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-300",high:"bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-300"};function T(i){return i?[...i].reverse():[]}function Xe({ticket:i,messages:o,users:z}){const[s,g]=a.useState(i),[u,h]=a.useState(()=>T(o?.data??[])),[R,C]=a.useState(o?.current_page??1),[W,A]=a.useState(o?.last_page??1),[j,E]=a.useState(!1),[f,X]=a.useState(!1),k=a.useRef(null),y=a.useRef(null),v=a.useRef(!1),b=a.useRef(!1),L=a.useRef(!1),$=R<W;a.useEffect(()=>{g(i),h(T(o?.data??[])),C(o?.current_page??1),A(o?.last_page??1)},[i.id,i.updated_at,o?.current_page]);const[H,P]=a.useState(""),[w,I]=a.useState({}),[D,q]=a.useState(!1),K=t=>{t.preventDefault(),I({}),q(!0);const n=document.querySelector('meta[name="csrf-token"]')?.getAttribute("content")??"";fetch(`/admin/tickets/${s.id}/reply`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json","X-CSRF-TOKEN":n,"X-Requested-With":"XMLHttpRequest"},body:JSON.stringify({message:H})}).then(async d=>{const r=await d.json().catch(()=>({}));d.ok&&d.status===201&&r.message?(P(""),b.current=!0,h(c=>c.find(p=>p.id===r.message.id)?c:[...c,r.message])):d.status===422&&r.errors&&I(r.errors)}).finally(()=>q(!1))},J=()=>{if(j||!$)return;const t=k.current,n=t?.scrollHeight??0,d=t?.scrollTop??0;E(!0),fetch(`/admin/tickets/${s.id}/messages?page=${R+1}`,{headers:{Accept:"application/json"}}).then(r=>r.json()).then(r=>{if(r.data?.length){const c=T(r.data);v.current=!0,y.current={prevHeight:n,prevTop:d},h(p=>[...c,...p]),C(r.current_page),A(r.last_page)}}).finally(()=>E(!1))},G=t=>{M.patch(`/admin/tickets/${s.id}/status`,{status:t},{preserveState:!0,preserveScroll:!0,only:[],replace:!1,onSuccess:()=>{g(n=>({...n,status:t}))}})},Q=t=>{const n=t==="unassigned"?null:t;M.patch(`/admin/tickets/${s.id}/assign`,{assigned_to:n},{preserveState:!0,preserveScroll:!0,only:[],replace:!1,onSuccess:()=>{g(d=>({...d,assigned_to:n?{id:n}:null}))}})},N=a.useRef(null),S=a.useRef(null);return a.useEffect(()=>{if(s.status==="closed")return()=>{};const t=s.id;let n=!1;const d=()=>{if(!(typeof window>"u"||!window.Echo))try{me(N.current);const r=S.current;r!=null&&(window.Echo.leaveChannel(`ticket.${r}`),S.current=null),N.current=null}catch(r){console.error("WebSocket: Error cleaning up channels",r)}};return(async()=>{try{const r=(await ee(async()=>{const{default:l}=await import("./echo-CLQcSlIV.js");return{default:l}},__vite__mapDeps([0,1,2]))).default();if(n||typeof window>"u")return;const c=l=>{l.message&&(b.current=!0,h(m=>m.find(Z=>Z.id===l.message.id)?m:[...m,l.message]))},p=l=>{g(m=>({...m,status:l.status||m.status,updated_at:l.timestamp||m.updated_at}))},Y=r.private(`ticket.${t}`).listen(".ticket.updated",p).listen(".ticket.message.created",c);n?r.leaveChannel(`ticket.${t}`):(N.current=Y,S.current=t)}catch(r){console.error("Failed to initialize WebSocket:",r)}})(),()=>{n=!0,d()}},[s.id,s.status]),a.useEffect(()=>{const t=k.current;if(t){if(v.current&&y.current){v.current=!1;const{prevHeight:n,prevTop:d}=y.current;y.current=null,requestAnimationFrame(()=>{t.scrollTop=t.scrollHeight-n+d});return}if(b.current){b.current=!1,requestAnimationFrame(()=>{t.scrollTop=t.scrollHeight});return}u.length>0&&!L.current&&(L.current=!0,requestAnimationFrame(()=>{t.scrollTop=t.scrollHeight}))}},[u]),e.jsxs(de,{breadcrumbs:ue,children:[e.jsx(te,{title:`Ticket: ${s.subject} - Admin`}),e.jsx("div",{className:"mx-auto flex w-full max-w-5xl flex-1 flex-col gap-2 overflow-hidden rounded-lg md:gap-3",children:e.jsxs("div",{className:"flex h-[calc(100vh-8rem)] min-h-[400px] flex-col overflow-hidden rounded-lg md:h-[calc(100vh-9rem)] md:min-h-[480px] md:border md:border-border md:bg-card md:shadow-sm",children:[e.jsxs("div",{className:"flex shrink-0 flex-wrap items-center gap-2 border-b bg-muted/30 px-3 py-2 dark:border-border md:gap-3 md:px-4 md:py-3",children:[e.jsx(se,{href:"/admin/tickets",className:"shrink-0 text-muted-foreground hover:text-foreground",children:e.jsx(ie,{className:"h-4 w-4 md:h-5 md:w-5"})}),e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsx("h1",{className:"truncate text-sm font-semibold md:text-base",children:s.subject}),e.jsxs("div",{className:"flex flex-wrap items-center gap-2 text-xs text-muted-foreground md:gap-3 md:text-sm",children:[e.jsx(_,{className:`shrink-0 text-[10px] md:text-xs ${pe[s.status]}`,children:s.status.replace("_"," ")}),e.jsx(_,{className:`shrink-0 text-[10px] md:text-xs ${xe[s.priority]}`,children:s.priority}),e.jsx("span",{className:"shrink-0",children:s.user?.name}),s.assigned_to&&e.jsxs("span",{className:"shrink-0",children:["→ ",s.assigned_to?.name]})]})]}),e.jsxs("div",{className:"flex shrink-0 items-center gap-2 md:gap-3",children:[e.jsxs(B,{value:s.status,onValueChange:G,children:[e.jsx(F,{className:"h-8 w-[120px] text-xs md:h-9 md:w-[140px] md:text-sm",children:e.jsx(V,{})}),e.jsxs(U,{children:[e.jsx(x,{value:"open",children:"Open"}),e.jsx(x,{value:"in_progress",children:"In Progress"}),e.jsx(x,{value:"closed",children:"Closed"})]})]}),e.jsxs(B,{value:s.assigned_to?.id?String(s.assigned_to.id):"unassigned",onValueChange:Q,children:[e.jsx(F,{className:"h-8 w-[130px] text-xs md:h-9 md:w-[150px] md:text-sm",children:e.jsx(V,{placeholder:"Unassigned"})}),e.jsxs(U,{children:[e.jsx(x,{value:"unassigned",children:"Unassigned"}),z?.map(t=>e.jsx(x,{value:String(t.id),children:t.name},t.id))]})]})]})]}),e.jsxs("div",{className:"shrink-0 border-b border-border/50 px-3 py-1 md:px-4 md:py-2",children:[e.jsxs("button",{type:"button",onClick:()=>X(t=>!t),className:"flex w-full items-center justify-between gap-2 py-1 text-left text-xs text-muted-foreground hover:text-foreground md:text-sm",children:[e.jsxs("span",{className:"truncate",children:[f?"Hide description":s.description?.slice(0,60),!f&&(s.description?.length??0)>60?"…":""]}),f?e.jsx(oe,{className:"h-3 w-3 shrink-0"}):e.jsx(le,{className:"h-3 w-3 shrink-0"})]}),f&&e.jsx("p",{className:"whitespace-pre-wrap py-2 text-xs text-muted-foreground md:text-sm md:leading-relaxed",children:s.description})]}),e.jsxs("div",{className:"flex min-h-0 flex-1 flex-col",children:[$&&e.jsx("div",{className:"shrink-0 flex justify-center border-b border-border/50 py-2 md:py-3",children:e.jsx(O,{variant:"ghost",size:"sm",className:"h-7 text-xs md:h-8 md:text-sm",onClick:J,disabled:j,children:j?"Loading…":"Load messages from above"})}),e.jsx("div",{ref:k,className:"min-h-0 flex-1 overflow-y-auto px-2 py-2 md:px-4 md:py-4",children:e.jsx("div",{className:"flex flex-col gap-1.5 md:gap-3",children:u&&u.length>0?u.map(t=>e.jsxs("div",{className:`rounded-lg px-2.5 py-1.5 md:rounded-xl md:px-4 md:py-3 ${t.is_admin?"bg-primary/10 dark:bg-primary/20":"bg-muted/60 dark:bg-muted/40"}`,children:[e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsxs("span",{className:"text-xs font-medium md:text-sm",children:[t.user?.name,t.is_admin&&e.jsx(_,{variant:"outline",className:"ml-1.5 text-[10px] md:ml-2 md:text-xs",children:"Admin"})]}),e.jsx("span",{className:"text-[10px] text-muted-foreground md:text-xs",title:new Date(t.created_at).toLocaleString(),children:ne(t.created_at)})]}),e.jsx("p",{className:"mt-0.5 whitespace-pre-wrap text-xs leading-snug md:mt-1 md:text-sm md:leading-relaxed",children:t.message})]},t.id)):e.jsx("p",{className:"py-6 text-center text-xs text-muted-foreground md:py-8 md:text-sm",children:"No messages yet."})})})]}),s.status!=="closed"&&e.jsxs("form",{onSubmit:K,className:"shrink-0 border-t border-border bg-background px-2 py-2 md:px-4 md:py-3",children:[e.jsxs("div",{className:"flex gap-2 md:gap-3",children:[e.jsx(ae,{id:"message",value:H,onChange:t=>P(t.target.value),required:!0,rows:2,placeholder:"Type your reply…",className:"min-h-[52px] resize-none text-sm md:min-h-[72px] md:rows-3 md:text-base"}),e.jsx(O,{type:"submit",disabled:D,className:"shrink-0 self-end",children:D?"Sending…":"Send"})]}),e.jsx(re,{message:Array.isArray(w.message)?w.message[0]:w.message})]})]})})]})}export{Xe as default};
