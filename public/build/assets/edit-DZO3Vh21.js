import{r as n,u as se,j as e,H as te,L as W,a as re}from"./app-DWDC-BVo.js";import{A as le,P as ie,a as ae,b as ne}from"./app-layout-Csx9VZt2.js";import{B as p}from"./createLucideIcon-CDiNb0OM.js";import{C as de,a as ce,b as oe,c as me}from"./card-ErUD2DV9.js";import{I as H}from"./input-WOpVy3_A.js";import{L as c}from"./label-Bm2ZFulM.js";import{S as z,a as M,b as O,c as V,d as b}from"./select-DUIPMlO7.js";import{D as ue}from"./date-picker-CNFyqeTr.js";import{C as S}from"./checkbox-DMqBXup4.js";import{I as h}from"./input-error-BbO5B7zM.js";import{P as pe}from"./plus-BwK_Jy3D.js";import{X as he}from"./x-Cr_BKX42.js";/* empty css            */import"./app-sidebar-header-r-OiXY8i.js";import"./index-B-id3RBu.js";import"./index-BspEiaub.js";import"./appearance-dropdown-Boh93vvE.js";import"./index-BCOzoWRm.js";import"./chevron-down-BehZftUK.js";import"./index-apnaeyBA.js";import"./index-l1Yz4tBP.js";import"./index-CcLcdVZM.js";import"./log-out-CNw_jzHT.js";import"./chevron-right-TaOApODu.js";import"./badge-BnVI9wD_.js";import"./proxy-8KyYWbtH.js";import"./circle-check-DngFYpsd.js";import"./loader-circle-_uqlEWjJ.js";import"./circle-x-DCRTT9my.js";import"./circle-alert-C7E7uvB-.js";import"./credit-card-DHCU20zw.js";import"./dollar-sign-DGtOSjhC.js";import"./message-square-DRz1er9_.js";import"./file-text-xQShroE0.js";import"./users-CtagEMWm.js";import"./user-check-Dt0Yb2Ws.js";import"./clock-D4ogtgGS.js";import"./shield-B0GD2scd.js";import"./index-D976Ylxv.js";import"./check-CooXHJVP.js";import"./chevron-up-CvrNtOh9.js";import"./calendar-CdmIu3LN.js";import"./format-BS8Ay9AX.js";import"./chevron-left-BSakv5Tz.js";import"./calendar-6IqibF-P.js";function ns({schedule:r,businesses:xe,employees:N,employeeTaxBreakdowns:m,employees_already_paid_this_period:E=[]}){const X=r.scheduled_date?new Date(r.scheduled_date+"T"+(r.scheduled_time||"00:00")):void 0,U=r.scheduled_time||"09:00",R=r.parsed_frequency||"monthly",_=r.employees?.map(s=>s.id)||[],C=N?.length||0,I=_.length===C&&C>0,[x,A]=n.useState(I?"all":"select"),[o,k]=n.useState(_),[g,T]=n.useState(""),[$,F]=n.useState([]),[q,L]=n.useState(!1),[j,v]=n.useState([]),[Z,G]=n.useState(!1),P=n.useRef(null),D=E.filter(s=>s.overlapping_jobs?.some(t=>t.status==="succeeded")),d=E.filter(s=>s.overlapping_jobs?.every(t=>t.status==="pending"||t.status==="processing")),{data:i,setData:a,put:Y,processing:J,errors:u}=se({business_id:r.business_id,name:r.name,schedule_type:r.schedule_type||"recurring",scheduled_date:r.scheduled_date||"",scheduled_time:U,frequency:R,employee_ids:_}),w=i.scheduled_date?new Date(i.scheduled_date+"T"+(i.scheduled_time||"00:00")):X,f=r.status==="cancelled";n.useEffect(()=>{if(P.current&&clearTimeout(P.current),!g.trim()||!i.business_id){F([]);return}P.current=setTimeout(async()=>{L(!0);try{const s=new URLSearchParams({business_id:String(i.business_id),query:g.trim()}),t=await fetch(`/employees/search?${s.toString()}`,{method:"GET",headers:{Accept:"application/json","X-Requested-With":"XMLHttpRequest"},credentials:"same-origin"});if(t.ok){const l=await t.json();F(l)}}catch(s){console.error("Search error:",s)}finally{L(!1)}},300)},[g,i.business_id]);const K=s=>{if(!o.includes(s.id)){const t=[...o,s.id];k(t),a("employee_ids",t)}T(""),F([])},Q=s=>{const t=o.filter(l=>l!==s);k(t),a("employee_ids",t)},B=s=>{if(s.preventDefault(),x==="all"){const t=N?.map(l=>l.id)||[];a("employee_ids",t)}else x==="select"&&a("employee_ids",o);Y(`/payroll/${r.id}`)},ee=s=>{s.preventDefault(),j.length!==0&&(G(!0),re.post(`/payroll/${r.id}/cancel-overlapping-jobs`,{employee_ids:j},{preserveScroll:!0,onFinish:()=>G(!1)}))};return e.jsxs(le,{breadcrumbs:[{title:"Payroll",href:"/payroll"},{title:"Edit",href:"#"}],children:[e.jsx(te,{title:"Edit Payroll Schedule"}),e.jsx("div",{className:"flex h-full flex-1 flex-col gap-4 overflow-x-auto rounded-xl p-4",children:e.jsxs(de,{children:[e.jsx(ce,{children:e.jsx(oe,{children:"Edit Payroll Schedule"})}),e.jsx(me,{children:e.jsxs("form",{onSubmit:B,className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(c,{htmlFor:"name",children:"Payroll Name"}),e.jsx(H,{id:"name",value:i.name,onChange:s=>a("name",s.target.value),required:!0}),e.jsx(h,{message:u.name})]}),e.jsxs("div",{children:[e.jsx(c,{htmlFor:"schedule_type",children:"Schedule Type"}),f?e.jsx("div",{className:"flex items-center gap-2 mt-2",children:e.jsx("span",{className:`inline-flex items-center rounded-full px-2 py-1 text-xs font-medium ${i.schedule_type==="one_time"?"bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200":"bg-purple-100 text-purple-800 dark:bg-purple-900 dark:text-purple-200"}`,children:i.schedule_type==="one_time"?"One-time":"Recurring"})}):e.jsxs(e.Fragment,{children:[e.jsxs(z,{value:i.schedule_type,onValueChange:s=>a("schedule_type",s),children:[e.jsx(M,{children:e.jsx(O,{})}),e.jsxs(V,{children:[e.jsx(b,{value:"recurring",children:"Recurring Payment"}),e.jsx(b,{value:"one_time",children:"One-time Payment"})]})]}),e.jsx(h,{message:u.schedule_type})]})]}),r.next_run_at_missing&&e.jsx("div",{className:"rounded-md border border-amber-200 bg-amber-50 px-3 py-2 text-sm text-amber-800 dark:border-amber-800 dark:bg-amber-950/30 dark:text-amber-200",children:"Next run not set. Set a date and time below and save to recalculate."}),D.length>0&&e.jsxs("div",{className:"rounded-md border border-blue-200 bg-blue-50 px-3 py-3 text-sm text-blue-900 dark:border-blue-800 dark:bg-blue-950/30 dark:text-blue-100",children:[e.jsxs("p",{className:"font-medium",children:[D.length," employee(s) already paid for this period will be skipped on the next run."]}),e.jsx("ul",{className:"mt-2 list-inside list-disc space-y-1",children:D.map(s=>e.jsxs("li",{children:[e.jsx("span",{className:"font-medium",children:s.name}),s.overlapping_jobs?.length>0&&e.jsxs("span",{className:"text-muted-foreground",children:[" ","— ",s.overlapping_jobs.map(t=>`${t.period_start} to ${t.period_end} (${t.status})`).join(", ")]})]},s.id))})]}),d.length>0&&e.jsxs("div",{className:"rounded-md border border-blue-200 bg-blue-50 px-3 py-3 text-sm text-blue-900 dark:border-blue-800 dark:bg-blue-950/30 dark:text-blue-100",children:[e.jsxs("p",{className:"font-medium",children:[d.length," employee(s) with a pending or in-progress payment for this period will be skipped."]}),e.jsx("ul",{className:"mt-2 list-inside list-disc space-y-1",children:d.map(s=>e.jsxs("li",{children:[e.jsx("span",{className:"font-medium",children:s.name}),s.overlapping_jobs?.length>0&&e.jsxs("span",{className:"text-muted-foreground",children:[" ","— ",s.overlapping_jobs.map(t=>`${t.period_start} to ${t.period_end} (${t.status})`).join(", ")]})]},s.id))}),!f&&e.jsxs("form",{onSubmit:ee,className:"mt-3 space-y-2",children:[e.jsx("p",{className:"text-xs font-medium",children:"Include in next run (cancels pending/processing payment for this period):"}),e.jsx("div",{className:"flex flex-wrap items-center gap-3",children:e.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[e.jsx(S,{checked:d.length>0&&d.every(s=>j.includes(s.id)),onCheckedChange:s=>{v(s?d.map(t=>t.id):t=>t.filter(l=>!d.some(y=>y.id===l)))}}),e.jsx("span",{className:"text-xs font-medium",children:"Select all"})]})}),e.jsx("div",{className:"flex flex-wrap gap-3",children:d.map(s=>e.jsxs("label",{className:"flex items-center gap-2 cursor-pointer",children:[e.jsx(S,{checked:j.includes(s.id),onCheckedChange:t=>{v(t?l=>[...l,s.id]:l=>l.filter(y=>y!==s.id))}}),e.jsx("span",{children:s.name})]},s.id))}),e.jsx(p,{type:"submit",variant:"secondary",size:"sm",disabled:j.length===0||Z,children:Z?"Processing…":"Include selected in next run"})]})]}),e.jsxs("div",{children:[e.jsx(c,{children:"Schedule Date & Time"}),f?e.jsx("div",{className:"mt-2",children:e.jsxs("p",{className:"text-sm text-muted-foreground",children:[w?w.toLocaleDateString():"N/A"," at ",i.scheduled_time]})}):e.jsxs(e.Fragment,{children:[e.jsx(ue,{date:w,onDateChange:s=>{if(s){const t=s.getFullYear(),l=String(s.getMonth()+1).padStart(2,"0"),y=String(s.getDate()).padStart(2,"0");a("scheduled_date",`${t}-${l}-${y}`)}else a("scheduled_date","")},time:i.scheduled_time,onTimeChange:s=>a("scheduled_time",s),showTime:!0}),e.jsx(h,{message:u.scheduled_date}),e.jsx(h,{message:u.scheduled_time}),e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:"Weekends and South Africa public holidays are not allowed"})]})]}),i.schedule_type==="recurring"&&e.jsxs("div",{children:[e.jsx(c,{htmlFor:"frequency",children:"Frequency"}),f?e.jsx("div",{className:"mt-2",children:e.jsx("p",{className:"text-sm text-muted-foreground capitalize",children:R})}):e.jsxs(e.Fragment,{children:[e.jsxs(z,{value:i.frequency,onValueChange:s=>a("frequency",s),children:[e.jsx(M,{children:e.jsx(O,{})}),e.jsxs(V,{children:[e.jsx(b,{value:"daily",children:"Daily"}),e.jsx(b,{value:"weekly",children:"Weekly"}),e.jsx(b,{value:"monthly",children:"Monthly"})]})]}),e.jsx(h,{message:u.frequency})]})]}),e.jsxs("div",{children:[e.jsx(c,{children:"Who gets this payroll?"}),f?e.jsx("div",{className:"mt-2",children:e.jsx("div",{className:"space-y-1",children:I?e.jsxs("p",{className:"text-sm text-muted-foreground",children:["All employees (",C," total)"]}):r.employees&&r.employees.length>0?r.employees.map(s=>e.jsxs("div",{className:"p-2 border rounded",children:[e.jsx("p",{className:"text-sm font-medium",children:s.name}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:["Gross: ZAR ",parseFloat(s.gross_salary).toLocaleString("en-ZA",{minimumFractionDigits:2,maximumFractionDigits:2})]}),m&&m[s.id]&&e.jsxs("p",{className:"text-xs text-green-600 mt-1",children:["Net: ZAR ",parseFloat(m[s.id].net).toLocaleString("en-ZA",{minimumFractionDigits:2,maximumFractionDigits:2})]})]},s.id)):e.jsx("p",{className:"text-sm text-muted-foreground",children:"No employees assigned"})})}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"space-y-4 mt-2",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(S,{id:"all_employees",checked:x==="all",onCheckedChange:s=>{s&&(A("all"),k([]),a("employee_ids",[]))}}),e.jsx(c,{htmlFor:"all_employees",className:"cursor-pointer font-normal",children:"All Employees"})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(S,{id:"select_employees",checked:x==="select",onCheckedChange:s=>{s&&A("select")}}),e.jsx(c,{htmlFor:"select_employees",className:"cursor-pointer font-normal",children:"Select Employees"})]}),e.jsx(h,{message:u.employee_ids})]}),x==="select"&&e.jsxs("div",{className:"space-y-2 mt-4",children:[e.jsx(c,{children:"Select Employees"}),N.length===0?e.jsxs("p",{className:"text-sm text-muted-foreground",children:["No employees found for this business. ",e.jsx(W,{href:"/employees/create",className:"text-primary underline",children:"Create an employee"})," first."]}):e.jsxs(e.Fragment,{children:[e.jsxs(ie,{children:[e.jsx(ae,{asChild:!0,children:e.jsxs(p,{type:"button",variant:"outline",className:"w-full justify-start",children:[e.jsx(pe,{className:"mr-2 h-4 w-4"}),q?"Searching...":"Search and add employees"]})}),e.jsxs(ne,{className:"w-80 p-0",align:"start",children:[e.jsx("div",{className:"p-2",children:e.jsx(H,{placeholder:"Search employees...",value:g,onChange:s=>T(s.target.value)})}),e.jsx("div",{className:"max-h-60 overflow-auto",children:$.length>0?e.jsx("div",{className:"p-2 space-y-1",children:$.map(s=>e.jsxs(p,{type:"button",variant:"ghost",className:"w-full justify-start",onClick:()=>K(s),disabled:o.includes(s.id),children:[s.name,s.email&&e.jsxs("span",{className:"text-xs text-muted-foreground ml-2",children:["(",s.email,")"]})]},s.id))}):g&&!q&&e.jsx("div",{className:"p-4 text-center text-sm text-muted-foreground",children:"No employees found"})})]})]}),o.length>0&&e.jsx("div",{className:"space-y-2 mt-2",children:o.map(s=>{const t=N?.find(l=>l.id===s);return t?e.jsxs("div",{className:"flex items-center justify-between p-2 border rounded-md",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("span",{className:"font-medium",children:t.name}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:["Gross: ZAR ",parseFloat(t.gross_salary||0).toLocaleString("en-ZA",{minimumFractionDigits:2,maximumFractionDigits:2})]}),m&&m[s]&&e.jsxs("p",{className:"text-xs text-green-600 mt-1",children:["Net: ZAR ",parseFloat(m[s].net).toLocaleString("en-ZA",{minimumFractionDigits:2,maximumFractionDigits:2})]})]}),e.jsx(p,{type:"button",variant:"ghost",size:"icon",className:"h-6 w-6",onClick:()=>Q(s),children:e.jsx(he,{className:"h-4 w-4"})})]},s):null})})]})]})]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(p,{type:"submit",disabled:J,children:"Update Payroll"}),e.jsx(W,{href:"/payroll",children:e.jsx(p,{type:"button",variant:"outline",children:"Cancel"})})]})]})})]})})]})}export{ns as default};
