import{r as a,u as Z,a as J,j as e,H as K,L as Q}from"./app-DWDC-BVo.js";import{I as o}from"./input-error-BbO5B7zM.js";import{B as v}from"./createLucideIcon-CDiNb0OM.js";import{C as Y,a as ee,b as se,c as re}from"./card-ErUD2DV9.js";import{I as f}from"./input-WOpVy3_A.js";import{L as n}from"./label-Bm2ZFulM.js";import{S,a as N,b as C,c as w,d as u}from"./select-DUIPMlO7.js";import{T as te}from"./textarea-D8Plv6wf.js";import{C as E}from"./checkbox-DMqBXup4.js";import{A as ie,P as le,a as ae,b as ne}from"./app-layout-Csx9VZt2.js";import{X as de}from"./x-Cr_BKX42.js";import{C as oe}from"./chevron-down-BehZftUK.js";/* empty css            */import"./index-l1Yz4tBP.js";import"./index-B-id3RBu.js";import"./index-D976Ylxv.js";import"./chevron-right-TaOApODu.js";import"./check-CooXHJVP.js";import"./chevron-up-CvrNtOh9.js";import"./index-apnaeyBA.js";import"./index-BspEiaub.js";import"./app-sidebar-header-r-OiXY8i.js";import"./appearance-dropdown-Boh93vvE.js";import"./index-BCOzoWRm.js";import"./index-CcLcdVZM.js";import"./log-out-CNw_jzHT.js";import"./badge-BnVI9wD_.js";import"./proxy-8KyYWbtH.js";import"./circle-check-DngFYpsd.js";import"./loader-circle-_uqlEWjJ.js";import"./circle-x-DCRTT9my.js";import"./circle-alert-C7E7uvB-.js";import"./plus-BwK_Jy3D.js";import"./credit-card-DHCU20zw.js";import"./dollar-sign-DGtOSjhC.js";import"./message-square-DRz1er9_.js";import"./file-text-xQShroE0.js";import"./users-CtagEMWm.js";import"./user-check-Dt0Yb2Ws.js";import"./clock-D4ogtgGS.js";import"./shield-B0GD2scd.js";const ce=[{title:"Adjustments",href:"/adjustments"},{title:"Create",href:"#"}];function Ye({businesses:P,selectedBusinessId:q,employee:i,employees:ue,payrollSchedules:O}){const A=new URLSearchParams(window.location.search),D=A.get("business_id"),k=A.get("employee_id"),[p,H]=a.useState(!!(i?.id||k)),[h,y]=a.useState(""),[R,x]=a.useState(!1),[g,m]=a.useState([]),[V,T]=a.useState(!1),[j,b]=a.useState(i||null),_=a.useRef(null),[I,L]=a.useState(O||[]),[X,F]=a.useState(!1),{data:r,setData:t,post:B,processing:U,errors:d}=Z({business_id:q||D||P[0]?.id||"",employee_id:i?.id||k||null,payroll_schedule_id:null,name:"",type:"fixed",amount:"",adjustment_type:"deduction",is_recurring:!0,payroll_period_start:"",payroll_period_end:"",is_active:!0,description:""});a.useEffect(()=>{if(r.business_id){const s={business_id:String(r.business_id)};r.employee_id&&(s.employee_id=String(r.employee_id)),J.get("/adjustments/create",s,{preserveState:!0,only:["payrollSchedules"],onSuccess:l=>{L(l.props.payrollSchedules||[])}})}else L([])},[r.business_id,r.employee_id]),a.useEffect(()=>{if(_.current&&clearTimeout(_.current),!h.trim()||!r.business_id){m([]);return}return _.current=setTimeout(async()=>{T(!0);try{const s=new URLSearchParams({business_id:String(r.business_id),query:h.trim()}),l=await fetch(`/employees/search?${s.toString()}`,{method:"GET",headers:{Accept:"application/json","X-Requested-With":"XMLHttpRequest"},credentials:"same-origin"});if(l.ok){const G=await l.json();m(G)}else m([])}catch(s){console.error("Error searching employees:",s),m([])}finally{T(!1)}},300),()=>{_.current&&clearTimeout(_.current)}},[h,r.business_id]);const $=()=>{r.business_id&&x(!0)},M=s=>{t("employee_id",s.id),b(s),y(""),x(!1),m([])},W=()=>{t("employee_id",null),b(null),y(""),x(!1),m([])};a.useEffect(()=>{if(r.employee_id&&j?.id!==r.employee_id){const s=g.find(l=>l.id===r.employee_id);s&&b(s)}else r.employee_id||b(null)},[r.employee_id,g]),a.useEffect(()=>{!r.is_recurring&&(r.employee_id||i?.id)&&r.payroll_schedule_id&&r.business_id?(F(!0),fetch(`/adjustments/calculate-period?payroll_schedule_id=${r.payroll_schedule_id}`,{headers:{Accept:"application/json","X-Requested-With":"XMLHttpRequest"},credentials:"same-origin"}).then(l=>{if(!l.ok)throw new Error("Failed to calculate period");return l.json()}).then(l=>{t("payroll_period_start",l.payroll_period_start),t("payroll_period_end",l.payroll_period_end),F(!1)}).catch(l=>{console.error("Failed to calculate period:",l),F(!1)})):!r.is_recurring&&!r.employee_id&&i?.id},[r.payroll_schedule_id,r.is_recurring,r.employee_id,i?.id]);const c=i?.id||r.employee_id||p,z=s=>{s.preventDefault(),!p&&!i&&t("employee_id",null),B("/adjustments")};return e.jsxs(ie,{breadcrumbs:ce,children:[e.jsx(K,{title:"Create Adjustment"}),e.jsx("div",{className:"flex h-full flex-1 flex-col gap-4 overflow-x-auto rounded-xl p-4",children:e.jsxs(Y,{children:[e.jsx(ee,{children:e.jsx(se,{children:"Create Adjustment"})}),e.jsx(re,{children:e.jsxs("form",{onSubmit:z,className:"space-y-4",children:[i&&e.jsxs("div",{className:"p-3 bg-muted rounded-lg",children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Employee-specific adjustment for:"}),e.jsx("p",{className:"font-medium",children:i.name})]}),e.jsxs("div",{children:[e.jsx(n,{htmlFor:"business_id",children:"Business"}),e.jsxs(S,{value:String(r.business_id),onValueChange:s=>{t("business_id",Number(s)),p&&t("employee_id",null)},disabled:!!i,children:[e.jsx(N,{children:e.jsx(C,{})}),e.jsx(w,{children:P.map(s=>e.jsx(u,{value:String(s.id),children:s.name},s.id))})]}),e.jsx(o,{message:d.business_id})]}),!i&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(E,{id:"is_employee_specific",checked:p,onCheckedChange:s=>{H(s),s||(t("employee_id",null),y(""))}}),e.jsx(n,{htmlFor:"is_employee_specific",className:"cursor-pointer",children:"Employee-specific adjustment"})]}),p&&e.jsxs("div",{children:[e.jsx(n,{htmlFor:"employee_id",children:"Employee"}),e.jsx("div",{className:"space-y-2",children:j?e.jsxs("div",{className:"flex items-center justify-between p-3 border rounded-md bg-muted/50",children:[e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:j.name}),j.email&&e.jsx("p",{className:"text-sm text-muted-foreground",children:j.email})]}),e.jsx(v,{type:"button",variant:"ghost",size:"icon",className:"h-6 w-6",onClick:W,children:e.jsx(de,{className:"h-4 w-4"})})]}):e.jsxs(le,{open:R,onOpenChange:x,children:[e.jsx(ae,{asChild:!0,children:e.jsxs(v,{type:"button",variant:"outline",role:"combobox","aria-expanded":R,className:"w-full justify-between",disabled:!r.business_id,onClick:()=>{r.business_id&&x(!0)},children:[e.jsx("span",{className:"text-muted-foreground",children:r.business_id?"Search employees...":"Select business first"}),e.jsx(oe,{className:"ml-2 h-4 w-4 shrink-0 opacity-50"})]})}),e.jsx(ne,{className:"w-[var(--radix-popover-trigger-width)] p-0",align:"start",children:e.jsxs("div",{className:"p-2",children:[e.jsx(f,{placeholder:"Search by name or email...",value:h,onChange:s=>{y(s.target.value)},onFocus:$,className:"mb-2"}),e.jsx("div",{className:"max-h-60 overflow-auto",children:V?e.jsx("div",{className:"p-3 text-center text-sm text-muted-foreground",children:"Searching..."}):g.length>0?e.jsx("div",{className:"space-y-1",children:g.map(s=>e.jsxs("button",{type:"button",onClick:()=>M(s),className:"w-full text-left px-3 py-2 rounded-sm hover:bg-accent hover:text-accent-foreground focus:bg-accent focus:text-accent-foreground focus:outline-none transition-colors",children:[e.jsx("p",{className:"font-medium",children:s.name}),s.email&&e.jsx("p",{className:"text-sm text-muted-foreground",children:s.email})]},s.id))}):e.jsx("div",{className:"p-3 text-center text-sm text-muted-foreground",children:h.trim()?"No employees found":"Start typing to search employees"})})]})})]})}),e.jsx(o,{message:d.employee_id}),!r.business_id&&e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:"Please select a business first to see employees"})]})]}),e.jsxs("div",{children:[e.jsx(n,{htmlFor:"name",children:"Adjustment Name"}),e.jsx(f,{id:"name",value:r.name,onChange:s=>t("name",s.target.value),placeholder:"e.g., Medical Aid, Pension Fund, Bonus",required:!0}),e.jsx(o,{message:d.name})]}),e.jsxs("div",{children:[e.jsx(n,{htmlFor:"adjustment_type",children:"Adjustment Type"}),e.jsxs(S,{value:r.adjustment_type,onValueChange:s=>t("adjustment_type",s),children:[e.jsx(N,{children:e.jsx(C,{})}),e.jsxs(w,{children:[e.jsx(u,{value:"deduction",children:"Deduction (reduces net salary)"}),e.jsx(u,{value:"addition",children:"Addition (increases net salary)"})]})]}),e.jsx(o,{message:d.adjustment_type})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(n,{htmlFor:"type",children:"Calculation Type"}),e.jsxs(S,{value:r.type,onValueChange:s=>t("type",s),children:[e.jsx(N,{children:e.jsx(C,{})}),e.jsxs(w,{children:[e.jsx(u,{value:"fixed",children:"Fixed Amount"}),e.jsx(u,{value:"percentage",children:"Percentage"})]})]}),e.jsx(o,{message:d.type})]}),e.jsxs("div",{children:[e.jsx(n,{htmlFor:"amount",children:r.type==="percentage"?"Percentage (%)":"Amount (ZAR)"}),e.jsx(f,{id:"amount",type:"number",step:(r.type==="percentage","0.01"),min:"0",max:r.type==="percentage"?"100":void 0,value:r.amount,onChange:s=>t("amount",s.target.value),required:!0}),e.jsx(o,{message:d.amount}),r.type==="percentage"&&e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:"Percentage of gross salary"})]})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(E,{id:"is_recurring",checked:r.is_recurring,onCheckedChange:s=>{t("is_recurring",s),s&&(t("payroll_period_start",""),t("payroll_period_end",""),t("payroll_schedule_id",null))}}),e.jsx(n,{htmlFor:"is_recurring",className:"cursor-pointer",children:"Recurring (applied automatically on every payroll run)"})]}),!r.is_recurring&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{children:[e.jsx(n,{htmlFor:"payroll_schedule_id",children:"Payroll Schedule *"}),e.jsxs(S,{value:r.payroll_schedule_id?String(r.payroll_schedule_id):"",onValueChange:s=>{s?t("payroll_schedule_id",Number(s)):(t("payroll_schedule_id",null),c&&(t("payroll_period_start",""),t("payroll_period_end","")))},disabled:!r.business_id,children:[e.jsx(N,{children:e.jsx(C,{placeholder:r.business_id?"Select payroll schedule":"Select business first"})}),e.jsx(w,{children:I.length>0?I.map(s=>e.jsxs(u,{value:String(s.id),children:[s.name," ",s.next_run_at&&`(${new Date(s.next_run_at).toLocaleDateString()})`]},s.id)):e.jsx(u,{value:"",disabled:!0,children:r.business_id?"No active payroll schedules found":"Select business first"})})]}),e.jsx(o,{message:d.payroll_schedule_id}),!r.business_id&&e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:"Please select a business first to see payroll schedules"})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4 p-4 bg-muted rounded-lg",children:[e.jsxs("div",{children:[e.jsxs(n,{htmlFor:"payroll_period_start",children:["Payroll Period Start",c&&e.jsx("span",{className:"text-xs text-muted-foreground ml-2",children:"(Auto-calculated)"})]}),e.jsx(f,{id:"payroll_period_start",type:"date",value:r.payroll_period_start,onChange:s=>t("payroll_period_start",s.target.value),required:!r.is_recurring,disabled:c,className:c?"bg-background":""}),X&&c&&e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:"Calculating period from schedule..."}),e.jsx(o,{message:d.payroll_period_start})]}),e.jsxs("div",{children:[e.jsxs(n,{htmlFor:"payroll_period_end",children:["Payroll Period End",c&&e.jsx("span",{className:"text-xs text-muted-foreground ml-2",children:"(Auto-calculated)"})]}),e.jsx(f,{id:"payroll_period_end",type:"date",value:r.payroll_period_end,onChange:s=>t("payroll_period_end",s.target.value),required:!r.is_recurring,disabled:c,className:c?"bg-background":""}),e.jsx(o,{message:d.payroll_period_end})]})]}),c&&r.payroll_period_start&&e.jsx("div",{className:"p-3 bg-blue-50 dark:bg-blue-950/20 border border-blue-200 dark:border-blue-800 rounded-lg",children:e.jsxs("p",{className:"text-sm text-blue-800 dark:text-blue-200",children:[e.jsx("strong",{children:"Note:"})," For employee-specific once-off adjustments, the payroll period is automatically calculated from the selected schedule. This ensures the adjustment will match exactly when the schedule processes payroll, preventing it from being applied to other schedules."]})})]}),e.jsxs("div",{children:[e.jsx(n,{htmlFor:"description",children:"Description (Optional)"}),e.jsx(te,{id:"description",value:r.description,onChange:s=>t("description",s.target.value),rows:3}),e.jsx(o,{message:d.description})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(E,{id:"is_active",checked:r.is_active,onCheckedChange:s=>t("is_active",s)}),e.jsx(n,{htmlFor:"is_active",className:"cursor-pointer",children:"Active (adjustment will be applied to payroll)"})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(v,{type:"submit",disabled:U,children:"Create Adjustment"}),e.jsx(Q,{href:i?`/employees/${i.id}/edit`:"/adjustments",children:e.jsx(v,{type:"button",variant:"outline",children:"Cancel"})})]})]})})]})})]})}export{Ye as default};
